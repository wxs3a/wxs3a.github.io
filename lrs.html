<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerJS狼人杀</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1, h2, h3 {
            color: #444;
        }
        .container {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #game-area {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        #players-list, #roles-list, #role-assignment {
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            min-height: 100px;
            background-color: #fafafa;
        }
        .role-btn {
            margin: 5px;
            padding: 8px 15px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .role-btn:hover {
            background-color: #3a5a8f;
        }
        #messages {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fefefe;
            border-radius: 5px;
        }
        #role-assignment select {
            padding: 8px;
            margin-left: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        #role-assignment div {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        input[type="text"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
            margin-right: 10px;
        }
        .player-action-btn {
            margin: 5px;
            padding: 8px 15px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .player-action-btn:hover {
            background-color: #3a5a8f;
        }
        .phase-indicator {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .night-phase {
            background-color: #333;
            color: white;
        }
        .day-phase {
            background-color: #f8d347;
            color: #333;
        }
        .role-card {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #e8f4fc;
            border-left: 4px solid #4a6fa5;
        }
        .dead-player {
            color: #999;
            text-decoration: line-through;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        .system-message {
            background-color: #f0f0f0;
            font-style: italic;
        }
        .death-message {
            background-color: #ffebee;
            color: #c62828;
            font-weight: bold;
        }
        .save-message {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>PeerJS狼人杀</h1>
    
    <div id="host-setup">
        <h2>创建游戏</h2>
        <button id="create-game">创建新游戏</button>
    </div>
    
    <div id="join-game">
        <h2>加入游戏</h2>
        <input type="text" id="game-id" placeholder="输入游戏ID">
        <input type="text" id="player-name" placeholder="你的昵称">
        <button id="join-button">加入游戏</button>
    </div>
    
    <div id="host-controls" class="container">
        <h2>主机控制面板</h2>
        <p>游戏ID: <span id="host-game-id"></span></p>
        
        <div>
            <h3>玩家列表</h3>
            <div id="players-list"></div>
        </div>
        
        <div>
            <h3>角色分配</h3>
            <div id="role-assignment"></div>
        </div>
        
        <button id="start-game" disabled>开始游戏</button>
    </div>
    
    <div id="player-view" class="container">
        <h2>玩家面板</h2>
        <p>游戏ID: <span id="player-game-id"></span></p>
        <p>你的昵称: <span id="display-name"></span></p>
        <div id="waiting-message">等待主机开始游戏...</div>
    </div>
    
    <div id="game-area" class="container">
        <div id="phase-indicator" class="phase-indicator"></div>
        <div id="role-info" class="role-card"></div>
        <div id="messages"></div>
        <div id="player-actions"></div>
    </div>
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // 游戏状态
        const gameState = {
            isHost: false,
            gameId: null,
            peer: null,
            connections: {},
            players: {},
            gameStarted: false,
            currentPlayerId: null,
            playerName: null,
            playerRole: null,
            isAlive: true,
            phase: null,
            witch: {
                poisonAvailable: true,
                antidoteAvailable: true
            },
            lastNightDeath: null
        };

        // DOM元素
        const elements = {
            hostSetup: document.getElementById('host-setup'),
            joinGame: document.getElementById('join-game'),
            hostControls: document.getElementById('host-controls'),
            playerView: document.getElementById('player-view'),
            gameArea: document.getElementById('game-area'),
            gameIdInput: document.getElementById('game-id'),
            playerNameInput: document.getElementById('player-name'),
            hostGameId: document.getElementById('host-game-id'),
            playerGameId: document.getElementById('player-game-id'),
            displayName: document.getElementById('display-name'),
            playersList: document.getElementById('players-list'),
            roleAssignment: document.getElementById('role-assignment'),
            messages: document.getElementById('messages'),
            playerActions: document.getElementById('player-actions'),
            phaseIndicator: document.getElementById('phase-indicator'),
            roleInfo: document.getElementById('role-info')
        };

        // 事件监听
        document.getElementById('create-game').addEventListener('click', createGame);
        document.getElementById('join-button').addEventListener('click', joinGame);
        document.getElementById('start-game').addEventListener('click', startGame);

        // 创建游戏
        function createGame() {
            gameState.isHost = true;
            gameState.peer = new Peer();
            
            gameState.peer.on('open', (id) => {
                gameState.gameId = id;
                elements.hostGameId.textContent = id;
                elements.hostSetup.style.display = 'none';
                elements.joinGame.style.display = 'none';
                elements.hostControls.style.display = 'block';
                
                addSystemMessage(`游戏已创建，ID: ${id}`);
            });
            
            gameState.peer.on('connection', (conn) => {
                if (gameState.gameStarted) {
                    conn.send({ type: 'game_already_started' });
                    conn.close();
                    return;
                }
                
                conn.on('open', () => {
                    const playerId = conn.peer;
                    gameState.connections[playerId] = conn;
                    
                    conn.on('data', (data) => handleHostMessage(data, conn));
                    conn.on('close', () => handlePlayerDisconnect(playerId));
                });
            });
            
            gameState.peer.on('error', (err) => {
                addSystemMessage(`错误: ${err.type} - ${err.message}`);
            });
        }

        // 加入游戏
        function joinGame() {
            const gameId = elements.gameIdInput.value.trim();
            const playerName = elements.playerNameInput.value.trim();
            
            if (!gameId || !playerName) {
                alert('请输入游戏ID和你的昵称');
                return;
            }
            
            gameState.playerName = playerName;
            gameState.peer = new Peer();
            
            gameState.peer.on('open', (id) => {
                gameState.currentPlayerId = id;
                const conn = gameState.peer.connect(gameId);
                
                conn.on('open', () => {
                    gameState.gameId = gameId;
                    elements.playerGameId.textContent = gameId;
                    elements.displayName.textContent = playerName;
                    elements.hostSetup.style.display = 'none';
                    elements.joinGame.style.display = 'none';
                    elements.playerView.style.display = 'block';
                    
                    // 发送加入请求
                    conn.send({
                        type: 'join',
                        playerId: id,
                        name: playerName
                    });
                });
                
                conn.on('data', (data) => handlePlayerMessage(data));
                conn.on('close', () => addSystemMessage('与主机的连接已断开'));
                
                gameState.connections.host = conn;
            });
            
            gameState.peer.on('error', (err) => {
                addSystemMessage(`错误: ${err.type} - ${err.message}`);
            });
        }

        // 开始游戏
        function startGame() {
            // 检查所有玩家是否都已分配角色
            const allRolesAssigned = Object.values(gameState.players).every(player => player.role);
            if (!allRolesAssigned) {
                alert('请为所有玩家分配角色');
                return;
            }
            
            // 检查至少有一个狼人和一个好人阵营玩家
            const players = Object.values(gameState.players);
            const hasWerewolf = players.some(p => p.role === 'werewolf');
            const hasGood = players.some(p => p.role !== 'werewolf');
            
            if (!hasWerewolf) {
                alert('至少需要1个狼人');
                return;
            }
            
            if (!hasGood) {
                alert('至少需要1个好人阵营玩家');
                return;
            }
            
            gameState.gameStarted = true;
            
            // 初始化玩家状态
            Object.values(gameState.players).forEach(player => {
                player.alive = true;
            });
            
            // 初始化女巫药水
            gameState.witch = {
                poisonAvailable: true,
                antidoteAvailable: true
            };
            
            // 发送角色信息给玩家
            Object.entries(gameState.players).forEach(([playerId, player]) => {
                gameState.connections[playerId].send({
                    type: 'role_assignment',
                    role: player.role
                });
            });
            
            // 更新界面
            updateRoleAssignment();
            document.getElementById('start-game').disabled = true;
            
            // 开始游戏流程
            startNightPhase();
        }

        // 开始夜晚阶段
        function startNightPhase() {
            gameState.phase = 'night';
            gameState.lastNightDeath = null; // 重置前一晚的死亡信息
            updatePhaseIndicator('夜幕降临，所有人请闭眼', 'night-phase');
            
            if (gameState.isHost) {
                broadcastMessage({ type: 'night_start' });
                
                // 找出所有狼人
                const werewolves = Object.entries(gameState.players)
                    .filter(([_, player]) => player.role === 'werewolf' && player.alive)
                    .map(([id, _]) => id);
                
                if (werewolves.length > 0) {
                    // 通知狼人互相认识
                    werewolves.forEach(werewolfId => {
                        gameState.connections[werewolfId].send({
                            type: 'werewolf_info',
                            werewolves: werewolves.filter(id => id !== werewolfId).map(id => gameState.players[id].name)
                        });
                    });
                    
                    // 设置狼人投票
                    setTimeout(() => {
                        startWerewolfVote(werewolves);
                    }, 3000);
                } else {
                    addSystemMessage('没有存活的狼人，直接进入白天');
                    setTimeout(startDayPhase, 3000);
                }
            }
        }

        // 狼人投票
        function startWerewolfVote(werewolves) {
            addSystemMessage('狼人请选择要杀死的玩家');
            
            if (gameState.isHost) {
                const alivePlayers = Object.entries(gameState.players)
                    .filter(([_, player]) => player.alive)
                    .map(([id, player]) => ({ id, name: player.name }));
                
                // 通知狼人投票
                werewolves.forEach(werewolfId => {
                    gameState.connections[werewolfId].send({
                        type: 'werewolf_vote',
                        players: alivePlayers
                    });
                });
            }
        }

        // 预言家查验
        function startSeerCheck() {
            if (gameState.isHost) {
                const seers = Object.entries(gameState.players)
                    .filter(([_, player]) => player.role === 'seer' && player.alive)
                    .map(([id, _]) => id);
                
                if (seers.length > 0) {
                    addSystemMessage('预言家请选择要查验的玩家');
                    
                    const alivePlayers = Object.entries(gameState.players)
                        .filter(([_, player]) => player.alive)
                        .map(([id, player]) => ({ id, name: player.name }));
                    
                    // 通知预言家查验
                    seers.forEach(seerId => {
                        gameState.connections[seerId].send({
                            type: 'seer_check',
                            players: alivePlayers
                        });
                    });
                } else {
                    setTimeout(startWitchAction, 3000);
                }
            }
        }

        // 女巫行动
        function startWitchAction() {
            if (gameState.isHost) {
                const witches = Object.entries(gameState.players)
                    .filter(([_, player]) => player.role === 'witch' && player.alive)
                    .map(([id, _]) => id);
                
                if (witches.length > 0 && gameState.lastNightDeath && !gameState.lastNightDeath.saved) {
                    addSystemMessage('女巫请选择是否使用解药');
                    
                    // 通知女巫行动
                    witches.forEach(witchId => {
                        gameState.connections[witchId].send({
                            type: 'witch_action',
                            killedPlayerId: gameState.lastNightDeath.id,
                            killedPlayerName: gameState.lastNightDeath.name,
                            antidoteAvailable: gameState.witch.antidoteAvailable,
                            poisonAvailable: gameState.witch.poisonAvailable
                        });
                    });
                } else {
                    setTimeout(startDayPhase, 3000);
                }
            }
        }

        // 开始白天阶段
        function startDayPhase() {
            gameState.phase = 'day';
            updatePhaseIndicator('天亮了，所有人请睁眼', 'day-phase');
            
            if (gameState.isHost) {
                broadcastMessage({ type: 'day_start' });
                
                // 显示前一晚的死亡信息
                if (gameState.lastNightDeath) {
                    let deathMsg = '';
                    if (gameState.lastNightDeath.saved) {
                        deathMsg = `${gameState.lastNightDeath.name} 被女巫用解药救活了`;
                        addSaveMessage(deathMsg);
                    } else {
                        deathMsg = `${gameState.lastNightDeath.name} 昨晚被狼人杀害`;
                        addDeathMessage(deathMsg);
                        
                        // 更新玩家状态
                        gameState.players[gameState.lastNightDeath.id].alive = false;
                        
                        // 检查猎人技能
                        if (gameState.players[gameState.lastNightDeath.id].role === 'hunter') {
                            setTimeout(() => {
                                startHunterAction(gameState.lastNightDeath.id);
                            }, 3000);
                            return;
                        }
                    }
                    
                    // 广播给所有玩家
                    broadcastMessage({
                        type: 'night_death',
                        message: deathMsg,
                        playerId: gameState.lastNightDeath.id,
                        saved: gameState.lastNightDeath.saved
                    });
                } else {
                    addSystemMessage('昨晚平安无事');
                    broadcastMessage({
                        type: 'night_death',
                        message: '昨晚平安无事',
                        playerId: null,
                        saved: false
                    });
                }
                
                // 检查游戏是否结束
                if (checkGameEnd()) {
                    return;
                }
                
                // 开始白天讨论和投票
                setTimeout(() => {
                    startDayVote();
                }, 5000);
            }
        }

        // 白天投票
        function startDayVote() {
            addSystemMessage('请讨论并投票处决一名玩家');
            
            if (gameState.isHost) {
                const alivePlayers = Object.entries(gameState.players)
                    .filter(([_, player]) => player.alive)
                    .map(([id, player]) => ({ id, name: player.name }));
                
                // 通知所有玩家投票
                broadcastMessage({
                    type: 'day_vote',
                    players: alivePlayers
                });
            }
        }

        // 猎人行动
        function startHunterAction(hunterId) {
            if (gameState.isHost) {
                const alivePlayers = Object.entries(gameState.players)
                    .filter(([id, player]) => player.alive && id !== hunterId)
                    .map(([id, player]) => ({ id, name: player.name }));
                
                if (alivePlayers.length > 0) {
                    addSystemMessage('猎人请选择要带走的玩家');
                    
                    gameState.connections[hunterId].send({
                        type: 'hunter_action',
                        players: alivePlayers
                    });
                } else {
                    addSystemMessage('没有其他存活的玩家可供猎人选择');
                    setTimeout(() => {
                        checkGameEnd() || setTimeout(startNightPhase, 3000);
                    }, 3000);
                }
            }
        }

        // 检查游戏是否结束
        function checkGameEnd() {
            const werewolves = Object.values(gameState.players)
                .filter(p => p.role === 'werewolf' && p.alive)
                .length;
            
            const goodPlayers = Object.values(gameState.players)
                .filter(p => p.role !== 'werewolf' && p.alive)
                .length;
            
            if (werewolves === 0) {
                addSystemMessage('好人阵营获胜！');
                broadcastMessage({ type: 'game_over', winner: 'good' });
                return true;
            } else if (werewolves >= goodPlayers) {
                addSystemMessage('狼人阵营获胜！');
                broadcastMessage({ type: 'game_over', winner: 'werewolves' });
                return true;
            }
            
            return false;
        }

        // 更新角色分配界面
        function updateRoleAssignment() {
            const roleAssignmentDiv = document.getElementById('role-assignment');
            roleAssignmentDiv.innerHTML = '';
            
            Object.entries(gameState.players).forEach(([playerId, player]) => {
                const playerDiv = document.createElement('div');
                playerDiv.style.margin = '10px 0';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${player.name}: `;
                if (!player.alive) nameSpan.classList.add('dead-player');
                playerDiv.appendChild(nameSpan);
                
                // 如果游戏已开始，显示固定角色
                if (gameState.gameStarted) {
                    const roleSpan = document.createElement('span');
                    roleSpan.textContent = getRoleName(player.role);
                    if (!player.alive) roleSpan.classList.add('dead-player');
                    playerDiv.appendChild(roleSpan);
                } 
                // 如果游戏未开始，显示角色选择下拉框
                else {
                    const select = document.createElement('select');
                    select.dataset.playerId = playerId;
                    
                    // 添加默认空选项
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = '未分配';
                    select.appendChild(emptyOption);
                    
                    // 添加可用角色选项
                    const availableRoles = ['werewolf', 'villager', 'seer', 'witch', 'hunter', 'idiot'];
                    availableRoles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role;
                        option.textContent = getRoleName(role);
                        option.selected = player.role === role;
                        select.appendChild(option);
                    });
                    
                    select.addEventListener('change', (e) => {
                        const selectedRole = e.target.value;
                        gameState.players[playerId].role = selectedRole || null;
                        checkStartGameConditions();
                    });
                    
                    playerDiv.appendChild(select);
                }
                
                roleAssignmentDiv.appendChild(playerDiv);
            });
        }

        // 更新玩家列表显示
        function updatePlayersList() {
            elements.playersList.innerHTML = Object.entries(gameState.players)
                .map(([id, player]) => {
                    const roleInfo = gameState.gameStarted && gameState.isHost ? 
                        ` (${getRoleName(player.role)})` : '';
                    const deadClass = !player.alive ? 'dead-player' : '';
                    return `<span class="${deadClass}">${player.name}${roleInfo}</span>`;
                })
                .join('<br>');
        }

        // 检查是否可以开始游戏
        function checkStartGameConditions() {
            const players = Object.values(gameState.players);
            const allRolesAssigned = players.every(player => player.role);
            const hasWerewolf = players.some(p => p.role === 'werewolf');
            const hasGood = players.some(p => p.role !== 'werewolf');
            
            document.getElementById('start-game').disabled = 
                !allRolesAssigned || !hasWerewolf || !hasGood;
        }

        // 处理主机收到的消息
        function handleHostMessage(data, conn) {
            switch (data.type) {
                case 'join':
                    if (gameState.gameStarted) {
                        conn.send({ type: 'game_already_started' });
                        conn.close();
                        return;
                    }
                    
                    gameState.players[data.playerId] = {
                        name: data.name,
                        alive: true,
                        role: null
                    };
                    
                    updatePlayersList();
                    updateRoleAssignment();
                    addSystemMessage(`${data.name} 加入了游戏`);
                    checkStartGameConditions();
                    break;
                    
                case 'werewolf_vote':
                    handleWerewolfVote(data, conn.peer);
                    break;
                    
                case 'seer_check':
                    handleSeerCheck(data, conn.peer);
                    break;
                    
                case 'witch_antidote':
                    handleWitchAntidote(data, conn.peer);
                    break;
                    
                case 'witch_poison':
                    handleWitchPoison(data, conn.peer);
                    break;
                    
                case 'day_vote':
                    handleDayVote(data, conn.peer);
                    break;
                    
                case 'hunter_shot':
                    handleHunterShot(data, conn.peer);
                    break;
                    
                case 'hunter_death':
                    startHunterAction(data.hunterId);
                    break;
            }
        }

        // 处理玩家收到的消息
        function handlePlayerMessage(data) {
            switch (data.type) {
                case 'role_assignment':
                    gameState.playerRole = data.role;
                    gameState.isAlive = true;
                    elements.playerView.style.display = 'none';
                    elements.gameArea.style.display = 'block';
                    
                    // 更新角色信息显示
                    const roleName = getRoleName(data.role);
                    const roleDescription = getRoleDescription(data.role);
                    elements.roleInfo.innerHTML = `
                        <h3>你的角色: ${roleName}</h3>
                        <p>${roleDescription}</p>
                    `;
                    
                    addSystemMessage(`你的角色是: ${roleName}`);
                    break;
                    
                case 'werewolf_info':
                    addSystemMessage(`其他狼人是: ${data.werewolves.join(', ')}`);
                    break;
                    
                case 'werewolf_vote':
                    showVoteOptions(data.players, 'werewolf_vote', '选择要杀死的玩家');
                    break;
                    
                case 'seer_check':
                    showVoteOptions(data.players, 'seer_check', '选择要查验的玩家');
                    break;
                    
                case 'witch_action':
                    showWitchAction(data);
                    break;
                    
                case 'night_start':
                    updatePhaseIndicator('夜幕降临，请闭眼', 'night-phase');
                    break;
                    
                case 'day_start':
                    updatePhaseIndicator('天亮了，请睁眼', 'day-phase');
                    break;
                    
                case 'day_vote':
                    showVoteOptions(data.players, 'day_vote', '投票处决一名玩家');
                    break;
                    
                case 'hunter_action':
                    showVoteOptions(data.players, 'hunter_shot', '选择要带走的玩家');
                    break;
                    
                case 'night_death':
                    if (data.message === '昨晚平安无事') {
                        addSystemMessage(data.message);
                    } else if (data.saved) {
                        addSaveMessage(data.message);
                    } else {
                        addDeathMessage(data.message);
                    }
                    
                    if (data.playerId === gameState.currentPlayerId && !data.saved) {
                        gameState.isAlive = false;
                        addSystemMessage('你已死亡，无法继续参与游戏');
                        elements.playerActions.innerHTML = '';
                        
                        // 如果是猎人，触发猎人技能
                        if (gameState.playerRole === 'hunter') {
                            setTimeout(() => {
                                if (gameState.isHost) {
                                    startHunterAction(gameState.currentPlayerId);
                                } else {
                                    gameState.connections.host.send({
                                        type: 'hunter_death',
                                        hunterId: gameState.currentPlayerId
                                    });
                                }
                            }, 3000);
                        }
                    }
                    break;
                    
                case 'seer_result':
                    addSystemMessage(`${data.playerName} 是 ${getRoleName(data.role)}`);
                    break;
                    
                case 'game_over':
                    addSystemMessage(`游戏结束，${data.winner === 'werewolves' ? '狼人' : '好人'}阵营获胜！`);
                    elements.playerActions.innerHTML = '';
                    break;
                    
                case 'game_already_started':
                    addSystemMessage('游戏已经开始，无法加入');
                    break;
            }
        }

        // 显示投票选项
        function showVoteOptions(players, voteType, titleText) {
            elements.playerActions.innerHTML = '';
            
            if (!gameState.isAlive) return;
            
            const title = document.createElement('h3');
            title.textContent = titleText;
            elements.playerActions.appendChild(title);
            
            players.forEach(player => {
                if (player.id === gameState.currentPlayerId) return;
                
                const btn = document.createElement('button');
                btn.className = 'player-action-btn';
                btn.textContent = player.name;
                btn.onclick = () => {
                    gameState.connections.host.send({
                        type: voteType,
                        targetId: player.id
                    });
                    elements.playerActions.innerHTML = '已投票，等待结果...';
                };
                elements.playerActions.appendChild(btn);
            });
            
            // 添加弃权选项
            const abstainBtn = document.createElement('button');
            abstainBtn.className = 'player-action-btn';
            abstainBtn.textContent = '弃权';
            abstainBtn.onclick = () => {
                elements.playerActions.innerHTML = '你选择了弃权';
            };
            elements.playerActions.appendChild(abstainBtn);
        }

        // 显示女巫行动选项
        function showWitchAction(data) {
            if (!gameState.isAlive || gameState.playerRole !== 'witch') return;
            
            elements.playerActions.innerHTML = '';
            
            const title = document.createElement('h3');
            title.textContent = `${data.killedPlayerName} 被狼人杀害，请选择行动`;
            elements.playerActions.appendChild(title);
            
            if (data.antidoteAvailable) {
                const saveBtn = document.createElement('button');
                saveBtn.className = 'player-action-btn';
                saveBtn.textContent = '使用解药救活';
                saveBtn.onclick = () => {
                    gameState.connections.host.send({
                        type: 'witch_antidote',
                        save: true
                    });
                    elements.playerActions.innerHTML = '你使用了解药';
                };
                elements.playerActions.appendChild(saveBtn);
            }
            
            if (data.poisonAvailable) {
                const poisonBtn = document.createElement('button');
                poisonBtn.className = 'player-action-btn';
                poisonBtn.textContent = '使用毒药杀人';
                poisonBtn.onclick = () => {
                    // 显示选择毒杀目标的界面
                    const alivePlayers = Object.entries(gameState.players)
                        .filter(([id, player]) => player.alive && id !== data.killedPlayerId)
                        .map(([id, player]) => ({ id, name: player.name }));
                    
                    showVoteOptions(alivePlayers, 'witch_poison', '选择要毒杀的玩家');
                };
                elements.playerActions.appendChild(poisonBtn);
            }
            
            const abstainBtn = document.createElement('button');
            abstainBtn.className = 'player-action-btn';
            abstainBtn.textContent = '不采取行动';
            abstainBtn.onclick = () => {
                gameState.connections.host.send({
                    type: 'witch_antidote',
                    save: false
                });
                elements.playerActions.innerHTML = '你没有采取任何行动';
            };
            elements.playerActions.appendChild(abstainBtn);
        }

        // 处理狼人投票
        function handleWerewolfVote(data, werewolfId) {
            if (!gameState.werewolfVotes) {
                gameState.werewolfVotes = {};
            }
            
            gameState.werewolfVotes[werewolfId] = data.targetId || null;
            
            const werewolves = Object.keys(gameState.players)
                .filter(id => gameState.players[id].role === 'werewolf' && gameState.players[id].alive);
            
            if (Object.keys(gameState.werewolfVotes).length === werewolves.length) {
                const validVotes = Object.values(gameState.werewolfVotes).filter(id => id !== null);
                
                if (validVotes.length === 0) {
                    addSystemMessage('所有狼人选择弃权，今晚无人死亡');
                    delete gameState.werewolfVotes;
                    setTimeout(startSeerCheck, 3000);
                    return;
                }
                
                // 统计投票结果
                const voteCounts = {};
                validVotes.forEach(id => {
                    voteCounts[id] = (voteCounts[id] || 0) + 1;
                });
                
                // 找出得票最多的玩家
                let maxVotes = 0;
                let killedPlayerId = null;
                
                Object.entries(voteCounts).forEach(([id, count]) => {
                    if (count > maxVotes) {
                        maxVotes = count;
                        killedPlayerId = id;
                    }
                });
                
                // 记录被杀玩家，等待女巫行动
                if (killedPlayerId) {
                    gameState.lastNightDeath = {
                        id: killedPlayerId,
                        name: gameState.players[killedPlayerId].name,
                        saved: false
                    };
                    
                    // 进入预言家查验阶段
                    setTimeout(startSeerCheck, 3000);
                }
                
                delete gameState.werewolfVotes;
            }
        }

        // 处理预言家查验
        function handleSeerCheck(data, seerId) {
            const targetPlayer = gameState.players[data.targetId];
            
            // 发送查验结果给预言家
            gameState.connections[seerId].send({
                type: 'seer_result',
                playerName: targetPlayer.name,
                role: targetPlayer.role
            });
            
            // 进入女巫行动阶段
            setTimeout(startWitchAction, 3000);
        }

        // 处理女巫解药
        function handleWitchAntidote(data, witchId) {
            if (data.save && gameState.lastNightDeath) {
                // 救活被狼人杀的玩家
                gameState.lastNightDeath.saved = true;
                gameState.witch.antidoteAvailable = false;
                
                addSystemMessage(`${gameState.players[witchId].name} 使用解药救活了 ${gameState.lastNightDeath.name}`);
            }
            
            // 进入白天阶段
            setTimeout(startDayPhase, 3000);
        }

        // 处理女巫毒药
        function handleWitchPoison(data, witchId) {
            const poisonedPlayer = gameState.players[data.targetId];
            poisonedPlayer.alive = false;
            gameState.witch.poisonAvailable = false;
            
            // 记录毒杀结果
            addSystemMessage(`${gameState.players[witchId].name} 使用毒药杀死了 ${poisonedPlayer.name}`);
            
            // 通知所有玩家
            broadcastMessage({
                type: 'player_killed',
                playerId: data.targetId,
                playerName: poisonedPlayer.name,
                reason: 'poison'
            });
            
            // 进入白天阶段
            setTimeout(startDayPhase, 3000);
        }

        // 处理白天投票
        function handleDayVote(data, voterId) {
            if (!gameState.dayVotes) {
                gameState.dayVotes = {};
            }
            
            gameState.dayVotes[voterId] = data.targetId;
            
            const alivePlayers = Object.keys(gameState.players)
                .filter(id => gameState.players[id].alive);
            
            if (Object.keys(gameState.dayVotes).length === alivePlayers.length) {
                // 统计投票结果
                const voteCounts = {};
                Object.values(gameState.dayVotes).forEach(id => {
                    voteCounts[id] = (voteCounts[id] || 0) + 1;
                });
                
                // 找出得票最多的玩家
                let maxVotes = 0;
                let executedPlayerId = null;
                
                Object.entries(voteCounts).forEach(([id, count]) => {
                    if (count > maxVotes) {
                        maxVotes = count;
                        executedPlayerId = id;
                    }
                });
                
                // 处决玩家
                if (executedPlayerId) {
                    gameState.players[executedPlayerId].alive = false;
                    
                    // 通知所有玩家
                    broadcastMessage({
                        type: 'player_killed',
                        playerId: executedPlayerId,
                        playerName: gameState.players[executedPlayerId].name,
                        reason: 'vote'
                    });
                    
                    // 如果是猎人，触发猎人技能
                    if (gameState.players[executedPlayerId].role === 'hunter') {
                        setTimeout(() => {
                            startHunterAction(executedPlayerId);
                        }, 3000);
                        return;
                    }
                }
                
                delete gameState.dayVotes;
                
                // 检查游戏是否结束
                if (!checkGameEnd()) {
                    // 进入夜晚
                    setTimeout(startNightPhase, 3000);
                }
            }
        }

        // 处理猎人开枪
        function handleHunterShot(data, hunterId) {
            const shotPlayer = gameState.players[data.targetId];
            shotPlayer.alive = false;
            
            // 通知所有玩家
            broadcastMessage({
                type: 'player_killed',
                playerId: data.targetId,
                playerName: shotPlayer.name,
                reason: 'hunter'
            });
            
            // 检查游戏是否结束
            if (!checkGameEnd()) {
                // 进入夜晚
                setTimeout(startNightPhase, 3000);
            }
        }

        // 处理玩家断开连接
        function handlePlayerDisconnect(playerId) {
            if (gameState.players[playerId]) {
                addSystemMessage(`${gameState.players[playerId].name} 离开了游戏`);
                delete gameState.players[playerId];
                delete gameState.connections[playerId];
                updatePlayersList();
                updateRoleAssignment();
                checkStartGameConditions();
            }
        }

        // 广播消息给所有玩家
        function broadcastMessage(message) {
            Object.values(gameState.connections).forEach(conn => {
                conn.send(message);
            });
            
            // 如果是主机，也给自己发消息
            if (gameState.isHost && gameState.currentPlayerId) {
                handlePlayerMessage(message);
            }
        }

        // 添加系统消息
        function addSystemMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system-message';
            messageElement.textContent = message;
            elements.messages.appendChild(messageElement);
            elements.messages.scrollTop = elements.messages.scrollHeight;
        }

        // 添加死亡消息
        function addDeathMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message death-message';
            messageElement.textContent = message;
            elements.messages.appendChild(messageElement);
            elements.messages.scrollTop = elements.messages.scrollHeight;
        }

        // 添加救人消息
        function addSaveMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message save-message';
            messageElement.textContent = message;
            elements.messages.appendChild(messageElement);
            elements.messages.scrollTop = elements.messages.scrollHeight;
        }

        // 更新阶段指示器
        function updatePhaseIndicator(text, phaseClass) {
            elements.phaseIndicator.textContent = text;
            elements.phaseIndicator.className = `phase-indicator ${phaseClass}`;
        }

        // 获取角色名称
        function getRoleName(role) {
            const roleNames = {
                werewolf: '狼人',
                villager: '村民',
                seer: '预言家',
                witch: '女巫',
                hunter: '猎人',
                idiot: '白痴'
            };
            return roleNames[role] || role;
        }

        // 获取角色描述
        function getRoleDescription(role) {
            const descriptions = {
                werewolf: '夜晚可以与其他狼人一起杀害一名玩家',
                villager: '没有特殊技能，白天参与讨论和投票',
                seer: '每晚可以查验一名玩家的身份',
                witch: '拥有一瓶解药和一瓶毒药，每晚可以使用其中一瓶',
                hunter: '死亡时可以开枪带走一名玩家',
                idiot: '被投票处决时可以翻牌免死，但失去投票权'
            };
            return descriptions[role] || '未知角色';
        }
    </script>
</body>
</html>
